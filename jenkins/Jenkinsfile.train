pipeline {
    agent any

    environment {
        // Nom du fichier .env inject√© dans le workspace
        ENV_PATH   = 'injected.env'
        // Destinataire des mails
        RECIPIENTS = 'aurelien.chalm@gmail.com'
        // Nom de l'image Docker de test
        IMAGE_NAME = 'fraud-train-test'
    }

    stages {

        stage('Pr√©parer le .env') {
            steps {
                // üî¥ ICI : on utilise un credential d√©di√© au projet Fraud/Stripe
                withCredentials([file(credentialsId: 'stripe_fraud_env', variable: 'REAL_ENV')]) {
                    script {
                        sh "rm -f $WORKSPACE/$ENV_PATH"
                        def envContent = readFile("${REAL_ENV}")
                        writeFile file: "$WORKSPACE/$ENV_PATH", text: envContent
                        sh "ls -l $WORKSPACE/$ENV_PATH"
                    }
                }
            }
        }

        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Build image de test') {
            steps {
                script {
                    sh """
                    docker build \
                      -t ${IMAGE_NAME} \
                      -f test/Dockerfile.train .
                    """
                }
            }
        }

        stage('Lancer les tests (retrain)') {
            steps {
                script {
                    // Le CMD du Dockerfile lance pytest ou ton script
                    sh """
                    docker run --rm \
                      --env-file $ENV_PATH \
                      ${IMAGE_NAME}
                    """
                }
            }
        }
    }

    post {
        success {
            emailext(
                subject: "‚úÖ [OK] Job ${env.JOB_NAME} build #${env.BUILD_NUMBER}",
                body: """
Bonjour coll√®gue,

Le job ${env.JOB_NAME} a r√©ussi avec le build #${env.BUILD_NUMBER}.

üîó Voir les logs : ${env.BUILD_URL}console

Bien √† toi,
Ton Jenkins pr√©f√©r√©
""",
                to: "${env.RECIPIENTS}",
                from: "aurelien.chalm@gmail.com"
            )
        }

        failure {
            emailext(
                subject: "‚ùå [ECHEC] Job ${env.JOB_NAME} build #${env.BUILD_NUMBER}",
                body: """
Bonjour coll√®gue,

Le job ${env.JOB_NAME} a √©chou√© sur le build #${env.BUILD_NUMBER}.

üîó Voir les logs : ${env.BUILD_URL}console

Bon courage pour le debug,
Ton Jenkins pr√©f√©r√©
""",
                to: "${env.RECIPIENTS}",
                from: "aurelien.chalm@gmail.com"
            )
        }

        always {
            script {
                // Optionnel: nettoyage de l'image
                sh "docker image ls ${IMAGE_NAME} || true"
            }
        }
    }
}